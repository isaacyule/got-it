<div class="wrapper">
  <div class="container-fluid kill-padding">
    <div class="row">

      <!-- body -->
      <div class="col-xs-12 col-lg-9">
        <div class="container kill-padding">
          <div class="row kill-padding">

            <!-- product pic -->
            <div class="col-xs-12 col-lg-5 kill-padding">
              <div class="row">
                <div class="col-xs-12">
                  <div class="product-photos kill-padding">
                    <% if @product.photo? %>
                      <%= cl_image_tag @product.photo %>
                    <% else %>
                      <img src=<%= asset_path"no_image.png" %>>
                    <% end %>
                  </div>
                </div>
                <div class="col-xs-12">
                  <div class="image-selector"><p>There's only one image of this product right now...</p></div>
                </div>
              </div>
            </div>

            <!-- product description -->
            <div class="col-xs-12 col-lg-7 kill-padding">
              <div class="product-description">
                <div class="row">
                  <div class="col-xs-12">
                    <h3><%= @product.name %></h3>
                  </div>
                  <div class="col-xs-12">
                    <p class="title"><strong>Description:</strong></p>
                  </div>
                  <div class="col-xs-12">
                    <p class="margin-bottom"><%= @product.description %></p>
                  </div>
                  <div class="col-xs-12">
                    <p class="title"><strong>Condition:</strong></p>
                  </div>
                  <div class="col-xs-12">
                    <p class="margin-bottom"><%= @product.condition %></p>
                  </div>
                  <div class="col-xs-12">
                    <div class="owner_card">
                      <p class="title"><strong>Owner:</strong></p>
                      <p ><%= @product.user["first_name"] %>
                        <%= @product.user["last_name"] %></p>
                      <p class="profile-text"> <%= @product.user.profile_text %></p>
                      <%= cl_image_tag @product.user.profile_photo, :transformation=>[
                      {:width=>200, :height=>200, :gravity=>"face", :radius=>"max", :crop=>"crop"},
                      {:width=>100, :crop=>"scale"}
                      ], class: "owner_card_photo" %>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- map -->
            <div class="col-xs-12 kill-padding">
              <div id="show-map" style="height: 400px"></div>
            </div>

            <!-- reviews -->
            <div class="col-xs-12 kill-padding buffer">
              <div class="product-reviews">
                <h3>Reviews</h3>
                <% if @product.rating.nan? %>
                  <h4>Overall Rating: Not yet rated</h4>
                <% else %>
                  <h4>Overall Rating: <%= @product.rating %></h4>
                <% end %>
                <%= link_to "WIP review link", new_product_review_path(@product) %>
                <div id="reviews-count">
                  <%= pluralize @product.reviews.size, "review" %>
                </div>
                <div id="reviews">
                  <% @product.reviews.order("id desc").each do |review| %>
                    <%= render 'reviews/show', review: review %>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- sidebar right -->
      <div class="col-xs-12 col-lg-3 kill-padding fix-parent">
        <div class="fixed-side kill-padding">
          <div class="request-form">
            <div class="price-per-day">
              <h3> <strong>£<span id="price_per_day"><%= @product.price_per_day%></span></strong></h3>
              <p> (per day)</p>
            </div>
            <div class="stars border-bottom">
              <% if @product.rating.nan? %>
                <p>no ratings yet</p>
              <% else %>
                <% @product.rating.round.to_i.times do %>
                <i class="fa fa-star grey-star" aria-hidden="true"></i>
                <!-- ToDo: Display products reviews and review-count -->
                <% end %>
              <% end %>
            </div>

            <!-- Daterantepicker -->
            <%= form_tag new_product_request_path(@product), method: :get do %>

              <input type="text" class="form-control" name="daterange" id="daterangepicker-requestform"/>

            <!-- Cost-Split -->
              <div class="border-bottom price-split">
                <p>Rental fee (<span id="days"></span> days):</p> <p>£<span id="rental_fee"></span></p>
              </div>
              <div class="border-bottom price-split">
                <p>Handover fee:</p> <p>£<span id="handover_fee"><%= @product.handover_fee.round(2)%></span></p>
              </div>
              <div class="border-bottom price-split">
                <p>Service fee:</p> <p>£<span id="service_fee"></span></p>
              </div>
              <div class="price-split">
                <p><strong>Total:</strong></p><p><strong>£<span id="total"></span></strong></p>
              </div>
              <div>
                <% if policy(@request).create? %>
                  <input type="submit" class="btn btn-lg btn-primary" id="request-button" value="Request">
                  <p>You won't be charged yet</p>
                <% else %>
                  <p class="own-product">This is your own product</p>
                <% end %>
              <% end %>
            </div>
            <div class="owner_links">
              <% if policy(@product).destroy? || policy(@product).edit?%>
                <p>As you are the owner you can...</p>
              <% end %>
               <% if policy(@product).edit? %>
                 <%= link_to "Edit", edit_product_path, class: 'btn btn-primary button' %>
               <% end %>
               <% if policy(@product).destroy? %>
                <%= link_to "Delete", product_path(@product), method: :delete, class: 'btn btn-danger button'%>
               <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<% content_for(:after_js) do %>
  <script>
    var days = 1
    document.addEventListener('DOMContentLoaded', () => {

      recalculatePrices();

  // --------- Map ---------
      var handler = Gmaps.build('Google');
      handler.buildMap({ internal: { id: 'show-map' } }, function() {
        markers = handler.addMarkers(<%= raw @hash.to_json %>);
        handler.bounds.extendWith(markers);
        handler.fitMapToBounds();
        if (markers.length == 0) {
          handler.getMap().setZoom(2);
        } else if (markers.length == 1) {
          handler.getMap().setZoom(14);
        }
      });

  // --------- Daterangepicker ---------
    $('input[name="daterange"]').daterangepicker(
      {
        locale: {
          format: 'DD-MM-YYYY'
        }
      // $('#calendar').fullCalendar({});

      }).on('apply.daterangepicker', function(e, picker) {
        days = picker.endDate.diff(picker.startDate, 'days') + 1 ;
        console.log(days);
        recalculatePrices();
        // `e` here contains the extra attributes
    });

      let pathName = window.location.pathname;
      let productID = pathName.match(/[\W{1}products\W{1}]\d+/)[0].substring(1)
      $('#calendar').fullCalendar({
        events: "/products/" + productID + ".json"
      });

      var nextButton = document.getElementById('request-button');
    })

  // --------- Calcualtion of price ---------
  function recalculatePrices() {
    $("#days").text(days);

    var price_per_day = (parseInt($("#price_per_day").text()));
    var rental_fee = +((price_per_day * days).toFixed(2));
    $("#rental_fee").text(rental_fee);

    var handover_fee = (parseInt($("#handover_fee").text()));
    var service_fee = +(((rental_fee + handover_fee) * 0.1).toFixed(2));
    $("#service_fee").text(service_fee);

    var total = (rental_fee + handover_fee + service_fee)
    $("#total").text(total);
  }

  </script>

<% end %>
