<div class="container-fluid">
  <div class="row">
    <div class="col-xs-12 col-md-9">
      <div class="row">
        <div class="col-xs-12">
          <div class="product-infos">
            <div class="product-photos">
              <% if @product.photo? %>
                <%= cl_image_tag @product.photo %>
              <% else %>
                <img src=<%= asset_path"no_image.png" %>>
              <% end %>
            </div>
            <div class="product-description">
              <h3><%= @product.name %></h3>
              <p class="title"><strong>Description:</strong></p>
              <p class="margin-bottom"><%= @product.description %></p>
              <p class="title"><strong>Condition:</strong></p>
              <p class="margin-bottom"><%= @product.condition %></p>
              <% if @end != nil %>
                <%= @end %>
                <% end %>

              <p class="title"><strong>Owner:</strong></p>
              <div class="owner_card">
                <p ><%= @product.user["first_name"] %>
                <%= @product.user["last_name"] %></p>
                <p class="profile-text"> <%= @product.user.profile_text %></p>
                <%= cl_image_tag @product.user.profile_photo, :transformation=>[
                  {:width=>200, :height=>200, :gravity=>"face", :radius=>"max", :crop=>"crop"},
                  {:width=>100, :crop=>"scale"}
                  ], class: "owner_card_photo" %>
                </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row hidden-xs">
        <div class="col-xs-12">
          <div id="show-map" style="width: 100%; height: 400px"></div>
        </div>
      </div>
      <div class="row">
        <div class="col-xs-12">
          <div id="calendar"></div>
        </div>
      </div>
      <div class="row">
        <div class="col-xs-12">
          <div class="product-reviews">
            <h3>Reviews</h3>
            <h4>Overall Rating: <%= @rating %></h4>
            <%= link_to "WIP review link", new_product_review_path(@product) %>
            <div id="reviews-count">
              <%= pluralize @product.reviews.size, "review" %>
            </div>
            <div id="reviews">
              <% @product.reviews.order("id desc").each do |review| %>
                <%= render 'reviews/show', review: review %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xs-12 col-md-3">
      <div class="fixed-side">
        <div class="owner_links">
          <% if policy(@product).destroy? || policy(@product).edit?%>
            <p>As you are the owner you can...</p>
          <% end %>
          <% if policy(@product).destroy? %>
            <%= link_to "Delete", product_path(@product), method: :delete, class: 'btn btn-primary'%>
           <% end %>
           <% if policy(@product).edit? %>
             <%= link_to "Edit", edit_product_path, class: 'btn btn-primary' %>
           <% end %>
        </div>
        <div class="request-form">
          <div class="price-per-day">
            <h3> <strong>£<span id="price_per_day"><%= @product.price_per_day%></span></strong></h3>
            <p> (per day)</p>
          </div>
          <div class="stars border-bottom">
            <% (5-@product.user[:stars]).times do %>
              <i class="fa fa-star grey-star" aria-hidden="true"></i>
              <!-- ToDo: Add review count -->
            <% end %>
          </div>

          <!-- Daterantepicker -->
          <%= form_tag new_product_request_path(@product), method: :get do %>

            <input type="text" class="form-control" name="daterange" id="daterangepicker-requestform"/>

          <!-- Cost-Split -->
            <div class="border-bottom price-split">
              <!-- ToDo: set days equal to picker -->
              <p>Rental fee:</p> <p>£<span id="rental_fee"></span></p>
            </div>
            <div class="border-bottom price-split">
              <p>Handover fee:</p> <p>£<span id="handover_fee"><%= @product.handover_fee.round(2)%></span></p>
            </div>
            <div class="border-bottom price-split">
              <p>Service fee:</p> <p>£<span id="service_fee"></span></p>
            </div>
            <div class="price-split">
              <p><strong>Total:</strong></p><p><strong>£<span id="total"></span></strong></p>
            </div>

            <% if policy(@request).create? %>
              <input type="submit" class="btn btn-lg btn-primary" id="request-butto">
              <p>You won't be charged yet</p>
            <% else %>
              <p class="own-product">This is your own product</p>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>


<% content_for(:after_js) do %>
  <script>
    var days = 1
    document.addEventListener('DOMContentLoaded', () => {

      recalculatePrices();

  // --------- Map ---------
      var handler = Gmaps.build('Google');
      handler.buildMap({ internal: { id: 'show-map' } }, function() {
        markers = handler.addMarkers(<%= raw @hash.to_json %>);
        handler.bounds.extendWith(markers);
        handler.fitMapToBounds();
        if (markers.length == 0) {
          handler.getMap().setZoom(2);
        } else if (markers.length == 1) {
          handler.getMap().setZoom(14);
        }
      });

  // --------- Daterangepicker ---------
      $('input[name="daterange"]').daterangepicker(
      {
        locale: {
          format: 'DD-MM-YYYY'
        }
      }).on('apply.daterangepicker', function(e, picker) {
        console.log(e);
        console.log(picker);
        days = picker.endDate.diff(picker.startDate, 'days') + 1 ;
        console.log(days);
        recalculatePrices();
        // `e` here contains the extra attributes
    });;

      let pathName = window.location.pathname;
      let productID = pathName.match(/[\W{1}products\W{1}]\d+/)[0].substring(1)
      $('#calendar').fullCalendar({
        events: "/products/" + productID + ".json"
      });

      var nextButton = document.getElementById('request-button');
      // nextButton.addEventListener
    })

  // --------- Calcualtion of price ---------
  function recalculatePrices() {
    // TODO
    var price_per_day = parseInt($("#price_per_day").text());
    var rental_fee = price_per_day * days;
    $("#rental_fee").text(rental_fee);

    var handover_fee = parseInt($("#handover_fee").text());
    var service_fee = (rental_fee + handover_fee) * 0.1
    $("#service_fee").text(service_fee);

    var total = rental_fee + handover_fee + service_fee
    $("#total").text(total);
  }

  </script>

<% end %>
